{
  admin off
}

:80 {
  # Storefront - main site
  @storefront {
    not path /dashboard/*
    not path /api/*
  }
  handle @storefront {
    reverse_proxy storefront:3000
  }

  # Dashboard - admin panel
  @dashboard path /dashboard/*
  handle @dashboard {
    uri strip_prefix /dashboard
    reverse_proxy dashboard:3001
  }

  # API proxy to backend services
  @api path /api/*
  handle @api {
    uri strip_prefix /api
    reverse_proxy broker:8080
  }

  # Security headers
  header {
    X-Content-Type-Options "nosniff"
    X-Frame-Options "DENY"
    X-XSS-Protection "1; mode=block"
    Referrer-Policy "strict-origin-when-cross-origin"
    Permissions-Policy "accelerometer=(), camera=(), geolocation=(), gyroscope=(), magnetometer=(), microphone=(), payment=(), usb=()"
    Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob: https:; font-src 'self' data:; connect-src 'self' ws: wss:; frame-ancestors 'none';"
    -Server
  }

  # Compression
  encode gzip zstd

  # Logging
  log {
    output stdout
    format console
  }
}

# Production with HTTPS
# {$DOMAIN:localhost} {
#   tls {
#     issuer acme {
#       email {$ACME_EMAIL}
#     }
#   }
#
#   @storefront {
#     not path /dashboard/*
#     not path /api/*
#   }
#   handle @storefront {
#     reverse_proxy storefront:3000
#   }
#
#   @dashboard path /dashboard/*
#   handle @dashboard {
#     uri strip_prefix /dashboard
#     reverse_proxy dashboard:3001
#   }
#
#   @api path /api/*
#   handle @api {
#     uri strip_prefix /api
#     reverse_proxy broker:8080
#   }
#
#   header {
#     Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
#     X-Content-Type-Options "nosniff"
#     X-Frame-Options "DENY"
#     X-XSS-Protection "1; mode=block"
#     Referrer-Policy "strict-origin-when-cross-origin"
#     Permissions-Policy "accelerometer=(), camera=(), geolocation=(), gyroscope=(), magnetometer=(), microphone=(), payment=(), usb=()"
#     Content-Security-Policy "default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval'; style-src 'self' 'unsafe-inline'; img-src 'self' data: blob: https:; font-src 'self' data:; connect-src 'self' ws: wss:; frame-ancestors 'none';"
#     -Server
#   }
#
#   encode gzip zstd
#
#   log {
#     output stdout
#     format json
#   }
# }
